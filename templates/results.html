<!--
/**************
This section of code uses a Bootstrap v4.0.0 (https://getbootstrap.com) script
 * Copyright 2011-2018 The Bootstrap Authors
 * Copyright 2011-2018 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
**************/
-->
<!doctype html>
<html lang="en" style="height: 100%;">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Search for n-grams within ancient Latin texts and visualize their absolute
    and relative frequency">
    <meta name="author" content="Silvia Pasciullo">

    <title>Latin N-Gram Viewer</title>

    <!-- Bootstrap core CSS -->
    <link href="{{ url_for('static', filename='css/bootstrap.css')}}" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{{ url_for('static', filename='css/dashboard.css')}}" rel="stylesheet">
  </head>

  <body style="display: flex; flex-direction: column; height: 100%;">
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
      <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="{{ url_for('index') }}">Latin N-Gram Viewer</a>
      <form class="form-inline my-2 my-lg-0" action="{{ url_for('search') }}" method="post" autocomplete="off">
        <!-- Set a regex pattern to exclude empty and whitespace characters from the search -->
        <input class="form-control form-control-dark w-100" name="ngram-search" type="text" placeholder="Search"
                 aria-label="Search" pattern="^(?!\s).*" title="Current input contains only whitespace characters" required>
      </form>
    </nav>

    <div class="container-fluid" style="height: 100%;">
      <div class="row" style="height: 100%;">

        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
          <div class="sidebar-sticky">
            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
              <span>Frequency Type</span>
              <a class="d-flex align-items-center text-muted" href="#">
              </a>
            </h6>
            <ul class="nav flex-column mb-2">
                <li class="nav-item">
                <a id="chart1Button" class="nav-link" href="#">
                  <span data-feather="bar-chart-2"></span>
                  Absolute Frequency
                </a>
              </li>
              <li class="nav-item">
                <a id="chart2Button" class="nav-link" href="#">
                  <span data-feather="bar-chart-2"></span>
                  Relative Frequency
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4" style="min-height:100%;">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
            <h3 class="h3">Results</h3>
          </div>

          <div id="chartContainer" style="height: 300px; width: 100%; margin-bottom: 20px;"></div>

          <div id="results-table" class="table table-striped" style="width: 100%; padding-bottom: 5.875em"></div>

          <div id="rig" style="font-size: x-small; text-align: justify; bottom: 6.375em; position: absolute; padding-right: 2.0625em; padding-left: 1.0625em;">The data used on this website is from the <a href="https://www.perseus.tufts.edu/hopper/" style="color: inherit;"><em>Perseus Digital Library</em></a> and together with other page content, unless otherwise stated, is subject to the <a href="https://creativecommons.org/licenses/by-sa/3.0/us/" style="color: inherit;">Creative Commons Attribution-ShareAlike 3.0 US Licence</a>
                <img src="././static/css/by-sa.svg" style="height: 17px; padding-right: 1.0625em;"></div>

          <footer style="font-size: smaller; text-align: center; padding-top: 0.9375em; height: 4.875em; width: 94%; position: absolute;
                 bottom: 0; border-top-width: 1px; border-top-style: solid; border-top-color: #dee2e6;">
            <span id="copyright" style="float: left; margin-bottom: 0.9375em; padding-left: 1.0625em;">Â© 2024, Silvia Pasciullo</span>
            <span id="app-info" style="float: right; margin-bottom: 0.9375em; padding-right: 3.0625em;"><a href="https://github.com/silviapasc/latin-n-gram-viewer" style="color: inherit;"><span data-feather="github"></span></a></span>
          </footer>

        </main>
      </div>
    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    

    <!-- Icons -->
    <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
    <script>
      feather.replace()
    </script>

    <!-- Graph -->
    <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
    
    <script>

        // Author: Silvia Pasciullo
        // License: CC BY-SA 3.0 US

       /* Define a function to display the absolute n-gram frequencies chart */
        loadFirstChart = function () {

            /* Import the JSON data and save it into the "json_data" variable */
            const json_data = {{ json|safe }};

            /* Initialize an object "tks" where the properties for each JSON object (i.e. n-gram) from the data
            *  are grouped by historical epoch and collected into an array */
            var tks = {}
            json_data.forEach(item => {
              item.forEach(i => {
                if (!(i.ngram in tks))
                    tks[i.ngram] = []
                    tks[i.ngram].push({label: i.id, y: i.frequency})
                })
            })


            /* Define an array containing all the n-grams searched within a session and to be displayed
               on the CanvasJS chart. Within the array, each n-gram is represented as an object encapsulating all
               its properties */
            var data_raw_freq = Object.keys(tks).map(ngram => {
              return {type: 'line',
                      name: ngram,
                      dataPoints: tks[ngram],
                      yValueFormatString: "#0.## occurrences",
                      showInLegend: true}
              })


            /* CanvasJS configuration for the absolute n-gram frequencies chart */
            const absolute_freq_chart = new CanvasJS.Chart("chartContainer", {
                animationEnabled: true,
                exportEnabled: true,
                axisY: {
                    title: "N-Gram Absolute Frequency"
                },
                legend: {
                    cursor: "pointer",
                    fontSize: 16,
                    /* The following function allows to click on each single n-gram name in the legend, so to hide the correspondent data visualization */
                    itemclick: function (e) {
                        e.dataSeries.visible = !(typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible);
                        absolute_freq_chart.render();
                    }
                },
                toolTip: {
                    shared: true
                },
                data: data_raw_freq
            });

            absolute_freq_chart.render();



         /* Set the function "findPointByX()" to to find a datapoint, based on its "x" value or property.
            The datapoint is found, thus returned, if its x-value matches with the "xValue" parameter passed to the function.
            Otherwise, nothing is returned */

          function findPointByX(seriesIndex, xValue) {
            // The variable "series" is intended as an n-gram object, at index "seriesIndex" and with all related data and chart settings
            const series = data_raw_freq[seriesIndex];

            // The variable "dataPoints" represents the array with the n-gram object data for each historical epoch.
            const dataPoints = series.dataPoints;

            for (const point of dataPoints) {
              // "point" corresponds to a single object (with properties "label", "x", "y", "mouseover", "click") within
              // the "dataPoints" array.
              // The x-property of "point", that has to be compared with "xValue", represents the historical epoch index
              // and in that sense can be a value between 0 and 3. Four are, in fact, the given epochs from the dataframe
              if (point.x === xValue) {
                return point;
              }
            }
              return null;
          }


         /* For each datapoint on the chart, set a click event handler to launch the table containing
            the absolute n-gram frequencies related to each text.
            If the absolute n-gram frequency is overall equal to zero, no table is displayed */
         absolute_freq_chart.options.data.forEach((series, seriesIndex) => {
          series.dataPoints.forEach((dataPoint, dataPointIndex) => {

            /* For each datapoint, set up a "mouseover" event handler that changes the "cursor" property
            to "pointer" when hovering over the datapoint itself. This will mean that a function related to the datapoint
            can be triggered */
            dataPoint.mouseover = function(setPointer){
                dataPoint.cursor = "pointer";
              }


            /* Set the function that is triggered when clicking on a datapoint, and that possibly displays
            * the table with the absolute n-gram frequencies in each text source */

            dataPoint.click = function(e) {
              // Bind the x-property, i.e. value, of each datapoint to the variable "clickedXValue"
              const clickedXValue = dataPoint.x;
              // Apply the "findPointByX()" function
              const matchingPoint = findPointByX(seriesIndex, clickedXValue);


                // Set a constraint, so to display the results table if there is at least one n-gram absolute frequency
                // for a certain historical epoch. In other words, no table is displayed when the "y" value is zero
                if (matchingPoint && (matchingPoint.x !== 0 && matchingPoint.y !== 0)
                        || (matchingPoint.x !== 1 && matchingPoint.y !== 0)
                        || (matchingPoint.x !== 2 && matchingPoint.y !== 0)
                        || (matchingPoint.x !== 3 && matchingPoint.y !== 0)
                        ) {


                    /* Define the parameters to be searched within the dataframe and save them into
                    variables */
                    let searchedValue1 = dataPoint.label; // 'Period' denomination, e.g. "3. Middle Republic (280-130 BC)"
                    let searchedValue2 = series.name; // n-gram denomination

                    // Get the "results-table" div-element from the HTML document and save it to "tagId"
                    const tagId = document.getElementById('results-table');

                    // Assign the n-gram absolute frequency subdataframes "tables" to "tagId" as "innerHTML" property
                    tagId.innerHTML = '{{ tables }}';

                    // Save the "tagId" content as one line string into "htmlTableString"
                    const htmlTableString = tagId.textContent;

                    /* Before converting the "htmlTableString" string into a JavaScript array, remove unuseful string characters
                       such as the opening "'[" and closing "]'" characters */
                    const updatedHtmlStr = htmlTableString.slice(2); // remove the opening "'["
                    const updatedHtmlStr2 = updatedHtmlStr.slice(0, updatedHtmlStr.length -2); // remove the closing "]'"
                  
                    /* Convert "updatedHtmlStr2" to a JavaScript array, so to split the different tables contained in it
                       at splitting point ", " */
                    const arr = updatedHtmlStr2.split(/', '/);


                    /* Iterate over each HTML table within the "arr" array to properly convert the tables
                    * from string to HTML format. Then access the HTML document as needed */
                    arr.forEach(tableItem => {

                          // Create a new DOM parser
                          const parser = new DOMParser();

                          // Convert the HTML tables as string into DOM content
                          const htmlDoc = parser.parseFromString(tableItem, "text/html");

                          // Extract the HTML table to be displayed for each datapoint
                          const htmlFrequencyTable = htmlDoc.firstElementChild;

                          // Define all the table row tags in the document
                          const rows = htmlFrequencyTable.querySelectorAll('tr');


                          // Set variable 'found' to 'false' as starting condition for next for-loop
                          let found = false;

                          /* Iterate over each single row of the table and check if both of the searched values
                             "searchedValue1" (Epoch denomination) and "searchedValue2" (n-gram denomination) are found
                             within the relative columns. If this is the case, change the "found" value to "true"
                          */
                          rows.forEach(row => {
                            if (row.innerHTML.includes(searchedValue1) && row.innerHTML.includes(searchedValue2)){
                              found = true;
                            }
                          });

                         // Display the whole absolute frequency table for the given datapoint, if a match is found
                            if (found) {
                              tagId.innerHTML = tableItem;
                              }
                        });

                } else {
                    // Return an empty "results-table" div, if no match is found
                    const resultDivEmpty = document.getElementById("results-table");
                    resultDivEmpty.innerHTML = null;
                }
            };
          });
        });



        };


       /* Define a function to display the relative n-gram frequencies chart */
       loadSecondChart = function() {

            /* Import the JSON data and save it into the "json_data2" variable */
            const json_data2 = {{ json|safe }};


            /* Initialize an object "tks2" where the properties for each JSON object (i.e. n-gram) from the data
            *  are grouped by historical epoch and collected into an array */
            var tks2 = {}
            json_data2.forEach(item2 => {
              item2.forEach(t => {
                if (!(t.ngram in tks2))
                    tks2[t.ngram] = []
                    tks2[t.ngram].push({label: t.id, y: t.frequencyRelative})
                })
            })



            /* Define an array containing all the n-grams searched within a session and to be displayed
               on the CanvasJS chart. Within the array, each n-gram is represented as an object encapsulating all
               its properties */
            var data_rel_freq = Object.keys(tks2).map(ngram => {
              return {type: 'line',
                      name: ngram,
                      dataPoints: tks2[ngram],
                      yValueFormatString: "#0.##########%",
                      showInLegend: true}
            })


             /* CanvasJS configuration for the relative n-gram frequencies chart */
            const chart2 = new CanvasJS.Chart("chartContainer", {
                animationEnabled: true,
                exportEnabled: true,
                axisY: {
                    title: "N-Gram Relative Frequency"
                },
                legend: {
                    cursor: "pointer",
                    fontSize: 16,
                  /* The following function allows to click on each n-gram name in the legend, so to hide the correspondent data visualization */
                    itemclick: function (e) {
                        e.dataSeries.visible = !(typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible);
                        chart2.render();
                    }
                },
                toolTip: {
                    shared: true
                },
                data: data_rel_freq
              });

            chart2.render();

            };


        /* Trigger the "loadFirstChart" function to display the absolute n-gram frequencies diagram as default results output */
        window.onload = loadFirstChart


        /* By means of the addEventListener() method attach a click event to each of the two buttons "chart1Button"
        and "chart2Button" in the left-hand navigation bar, so to display the absolute and the relative chart respectively*/
        document.addEventListener("DOMContentLoaded", function() {
          // Button for chart 1
          document.getElementById("chart1Button").addEventListener("click", loadFirstChart);
          // Button for chart 2
          document.getElementById("chart2Button").addEventListener("click", loadSecondChart);
          });


        /* Toggle between adding and removing the "responsive" class to the "topnav" element when the user clicks on the icon */
        function responsiveNavbar() {
          var x = document.getElementById("nav-navbar");
          if (x.className === "nav-navbar") {
            x.className += " responsive";
          } else {
            x.className = "nav-navbar";
          }
        }



    </script>
  </body>
</html>
